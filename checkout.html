<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Checkout — C⁴AT³ Analyzer</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon"/>
  <link rel="stylesheet" href="./style.css"/>
  <script defer src="./script.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-row">
      <a class="brand" href="/" aria-label="Templet Solutions Home">
        <img src="./images/logo.png" alt="Templet Solutions" class="brand-logo">
      </a>
      <nav class="main-nav">
        <ul class="nav-links">
          <li><a href="/" data-nav="home">Home</a></li>
          <li><a href="/#pricing" data-nav="pricing">Pricing</a></li>
          <li><a href="./dashboard.html">Dashboard</a></li>
          <li><button id="logoutButtonCk" class="btn-link danger" style="display:none;">Log out</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <div class="card checkout">
        <h2>Checkout</h2>
        <p id="planIntro" class="muted">Preparing your plan…</p>

        <div class="summary">
          <div class="row"><span>Plan</span><strong id="summaryPlan">—</strong></div>
          <div class="row"><span>Monthly uses</span><strong id="summaryUses">—</strong></div>
          <div class="row"><span>Price</span><strong id="summaryPrice">—</strong></div>
        </div>

        <div class="notice" id="loginNotice" style="display:none;">
          You’ll need an account before checkout. <a href="/#pricing">Create one here</a>.
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="checkoutStart">Start checkout</button>
          <a class="btn btn-ghost" href="/#pricing">Back to pricing</a>
        </div>

        <p class="small muted" id="checkoutHelp"></p>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>© <span id="year"></span> Templet Solutions LLC</div>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const params = new URLSearchParams(window.location.search);
    const plan = (params.get('plan') || '').toLowerCase();

    const catalogue = {
      starter: { name: 'Starter', uses: 20, price: '$12.99/mo', code: 'starter' },
      professional: { name: 'Professional', uses: 60, price: '$22.99/mo', code: 'professional' },
      pro: { name: 'Pro', uses: 150, price: '$39.99/mo', code: 'pro' }
    };

    const selected = catalogue[plan];
    const loginNotice = document.getElementById('loginNotice');

    if (!selected) {
      document.getElementById('planIntro').textContent = 'No plan selected.';
      document.getElementById('checkoutStart').disabled = true;
    } else {
      document.getElementById('summaryPlan').textContent = selected.name;
      document.getElementById('summaryUses').textContent = `${selected.uses}`;
      document.getElementById('summaryPrice').textContent = selected.price;
      document.getElementById('planIntro').textContent = 'You’re checking out with:';
    }

    // Show logout if authed
    if (window.C4AT3Auth.getToken()) {
      document.getElementById('logoutButtonCk').style.display = '';
      document.getElementById('logoutButtonCk').addEventListener('click', () => {
        window.C4AT3Auth.clear();
        window.location.reload();
      });
    } else {
      loginNotice.style.display = '';
    }

    document.getElementById('checkoutStart').addEventListener('click', async () => {
      if (!selected) return;

      // Require auth first
      if (!window.C4AT3Auth.getToken()) {
        document.getElementById('checkoutHelp').textContent = 'Please create an account or log in before checkout.';
        return;
      }

      // Create backend session -> redirect URL (if available)
      try {
        const r = await window.C4AT3Auth.authedFetch('/api/billing/create-session', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ plan: selected.code })
        });

        if (r.ok) {
          const data = await r.json();
          if (data.url) {
            window.location.href = data.url; // e.g., Stripe Checkout
            return;
          }
        }

        // Fallback: if no billing route yet, just soft-upgrade and route to dashboard.
        const up = await window.C4AT3Auth.authedFetch('/api/users/upgrade', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ tier: selected.code })
        });

        if (up.ok) {
          window.location.href = './dashboard.html';
        } else {
          document.getElementById('checkoutHelp').textContent = 'Checkout endpoint unavailable. Ask support to enable billing.';
        }

      } catch (err) {
        document.getElementById('checkoutHelp').textContent = 'Network or server error starting checkout.';
      }
    });
  </script>
</body>
</html>
